# Анализ проблем и планирование решений для компании «Александрит»

## 1. Анализ текущих проблем

На основе предоставленной информации и архитектурной схемы выявлены следующие проблемы:

1. **Просроченные заказы**
   - Не ясно, на каком именно этапе в системе возникают проблемы с потерей / застреванием заказов - не хватает системы мониторинга и алертинга

2. **Перегруженный MES**
   - MES выполняет слишком много задач: расчет стоимости, список заказов, управление заказами для операторов. Выглядит как монолитная система.
   - MES рассчитывает стоимость заказа от 2–3 минут до 30 минут в зависимости от сложности модели - выглядит как асинхронный процесс, который нужно выносить в отдельный сервис

4. **Рост загрузки**
   - Линейный рост заказов (+100 в месяц), что увеличивает нагрузку на все сервисы, нужно предусмотреть масштабируемость узких мест
   - Введение API для внешних заказчиков резко увеличило количество заказов. При этом, заказ создается как-то странно - внешний пользователь сперва дергает MES API, а потом он уже создает заказ в CRM, кажется должно быть наоборот. Сперва работаем с клиентом, потом он создает заказ. Это бы позволило повысить видимость заказов в системе, так как они бы проходили сперва через менеджеров. Самой по себе проблемы в предоставлении доступа к API внешнием клиентам нет, есть много компаний которые этим занимаются, но надо наладить процесс с точки зрения управления доступом / оплат и тд

5. **Узкие места архитектуры**
   - RabbitMQ может быть перегружен из-за большого количества сообщений - без мониторинга сложно понять есть ли проблемы
   - Базы данных работают в режиме единственного инстанса, возможны проблемы с производительностью
   - Приложения также работают в режиме единственного инстанса, что исключает возможность адаптации к нагрузке
   - Дисбаланс операций на чтение и на запись: создается много заказов (запись), однако, операторы должны постоянно обновлять список, чтобы мониторить последние изменения (чтение), а также сами заказчики проверяют статус заказов (чтение). В итоге скорее всего чтения больше чем записи.

6. **Задержки релизов**
   - QA тестирует все вручную, что задерживает релизы и может приводить к человеческим ошибкам.
   - Баги уровня high или highest блокируют выпуск новых версий, что говорит о медленном исправлении багов (возможно из-за перегруза команды или плохого управления процессом разработки)
   - В последние месяцы задержки релизов превышают один месяц, что также может говорить о перегрузе команды и плохо налаженном процессе разработки

7. **Не автоматизированность CI/CD**
   - Отсутствие автоматизированных тестов перед деплоем на релизные и продакшн-окружения.
   - Развертывание в release и prod выполняется вручную, что увеличивает время доставки изменений и повышает риск человеческих ошибок.
   - Нет возможности быстрого отката на предыдущую версию в случае неудачного релиза.
   - Отсутствует автоматическое тестирование после развертывания, что увеличивает вероятность появления критических ошибок на проде.

8. **Отсутствие кеширования**
   - MES загружает и рассчитывает данные каждый раз заново, что приводит к задержкам.
   - Список заказов у операторов загружается медленно из-за отсутствия кэширования списков заказов.
   - Частые повторные запросы к базе данных увеличивают нагрузку.
   - Нет механизма кэширования расчетов стоимости, что увеличивает время обработки заказов. Есть вероятность того, что при определенных условиях расчет может запускаться заново, без дополнительных проверок (например, пользователь повторно загрузил файл)

9. **Отсутствие системы мониторинга и логирования**
   - Нет централизованного мониторинга ключевых метрик (RabbitMQ, базы данных, MES API, CRM API).
   - Отсутствие алертов на критические события, такие как задержки обработки заказов, перегрузка RabbitMQ, падение инстансов.
   - Нет логирования запросов и проблемных операций, что затрудняет отладку и анализ узких мест.

10. **Отсутствие системы трейсинга**
    - Нет механизма трассировки запросов между микросервисами, что затрудняет диагностику задержек и ошибок.
    - Отсутствие распределенного трейсинга не позволяет эффективно отслеживать путь заказов по всей системе.
    - Нет визуального представления трассировки запросов, что увеличивает время на поиск проблемных мест.

11. **Проблемы со стороны команды**
    - Единая, коллективная ответственность за весь продукт - нет разделения на зоны ответственности. Например, два инженера фронтона - три приложения.
    - Недостаточные компетенции команды: 
      - Самый проблемный сервис - MES использует React, но только один фронт частично знает его. 
      - Лид - бывший разработчик C#: в продукте много разных технологий, этого может быть недостаточно. 
      - QA инженер хочет автоматизировать тестирование, но у него нет широкого опыта, не хватает какого-то менторства / более опытного QA автоматизатора
    - Разработка новых фич и устранение багов занимает слишком много времени видимо из-за отсутствия автоматизированного тестирования и недостаточного количества человек в команде.
    - DevOps-инженер перегружен из-за необходимости вручную управлять релизами, отсутствия автоматизированного деплоя и мониторинга.

12. **Проблемы QA (помимо затронутых выше)**
    - QA инженер тестирует продукт на тесовом окружении. Однако, он должен тестировать и на release и на проде. Особенно когда на релиз и на прод выкатываются изменения в ручном режиме (помимо всего прочего). Конечно же, делать это вручную физически невозможно одному человеку.

14. **Что-то не так с оплатой**
    - Ее вообще нет на схеме, поэтому она не будет рассматриваться



## 2. Инициативы для устранения проблем

1. **Работа с командой**
   - Нанять дополнительного фронтенд разработчика с опытом работы в React для разработки и оптимизации MES.
   - Увеличить команду QA за счёт специалиста по автоматизированному тестированию, который сможет менторить текущего QA-инженера.
   - Включить в команду второго DevOps-инженера для распределения нагрузки и ускорения автоматизации CI/CD процессов.

2. **Ввести кэширование данных**
   - Это позволит снизить нагрузку на сервисы (в первую очередь MES)
   - Исключит риск повторных расчетов для MES API

3. **Мониторинг и алерты**
   - Введение более детального мониторинга RabbitMQ и базы данных.
   - Настройка алертов по времени обработки заказов.
   - Логирование и централизованное хранилище логов для лучшего анализа инцидентов.

4. **Внедрение системы трейсинга**
   - Введение  трейсинга запросов между микросервисами.
   - Связка логов между сервисами для быстрого поиска проблем.
   - Визуальное представление потоков запросов для диагностики узких мест.

5. **Горизонтальное масштабирование MES API**
   - Добавить возможность поднятия нескольких инстансов MES API.
   - Вынести расчёт стоимости в отдельный микросервис, чтобы разгрузить API.
   - Добавить в систему еще один статус - PRICE_CALCULATION_STARTED. Тогда совместно с PRICE_CALCULATED можно будет отслеживать время расчета
   - Разделить очередь обработки сложных и простых моделей.

6. **Автоматизация тестирования**
   - Внедрение автоматизированного тестирования (E2E, API-тестирование).

7. **Масштабирование базы данных**
   - Перенос наиболее нагруженных таблиц в реплику для чтения.
   - Рассмотреть вариант шардинга для высоконагруженных данных.


8. **Обновить бизнес процесс по MES API**
   - Вместо того чтобы MES создавал заказы в CRM, поменять схему доступа к API на обратную, когда сперва CRM, потом уже MES API


## 3. Приоритетность инициатив
### Приоритет по всем инициативам

1. **_Работа с командой._** 

Без изменений в команде сложно представить, что другие запланированные изменения будут внедрятся достаточно быстро и качественно, потому что:
   - Нехватка людей не позволит внедрить инициативы из-за перегруза текущими задачами
   - Нехватка скиллов не позволит внедрить изменения на должном уровне

К тому же, нанять дополнительных людей - не быстрый процесс, поэтому нужно начать чем раньше тем лучше

2. **_Мониторинг и алерты_**

Мониторинг - это важная часть, которая поможет понять что происходит сейчас, а также отслеживать как работает приложение после вносимых изменений

3. **_Внедрение системы трейсинга._**

Ключевая проблема - теряются заказы, неизвестно где они застревают, а значит и не понятно как чинить. 
Поэтому надо настроить трейсинг, чтобы можно было более точно понимать где именно возникают проблемы в приложении

4. **_Ввести кэширование данных_**

Скорее всего, введение кеширования поможет частично снять остроту всех проблем достаточно быстро, чтобы выйграть время для более серьезных изменений в архитектуре. То есть получить результат максимально быстро.


5. **_Горизонтальное масштабирование MES API_**

Скорее всего, ядро всех проблем в текущем приложении - это MES API, поэтому его надо масштабировать.
Ключевые сигналы того что это так:
- Долгие расчеты (2-3 минуты на один заказ)
- При условии, что каждый месяц добавляется + 100 заказов (что при последовательной обработке выливается в +5 часов расчетов), выглядит так, что сервис уже скорее всего захлебывается именно из-за расчетов
- Объединены расчеты и страница со списком для пользователей (то есть одно сильно влияет на другое)


6. **_Бизнес процесс MES API_**

После внедрения мониторинга можно приступать к дополнительным изменениям (поменять стрелочку с MES API -> CRM на CRM -> MES API)

7. **_Автоматизация тестирования_**

Сейчас будут производиться масштабные изменения в приложении. Риск что-то поломать в процессе крайне высокий. Мы не можем себе позволить ухудшить ситуацию еще сильнее и попутно терять время на медленном тестировании, пока бизнес ждет изменений и теряет деньги.
К тому же, процесс автоматизации тестирования может параллелиться с остальными этапами.

8. **_Масштабирование базы данных_**

На последнем месте, потому что:
- Некоторые другие инициативы уменьшают необходимость быстрого внедрения шардинга/реплецирования БД. 
  - Например, кеширование снимает нагрузку на базу
  - Выделение отдельного сервиса расчетов MES скорее всего положительно повлияет и на само приложение, которое видят пользователи
- Дополнительные копии баз - это дополнительные затраты на инфраструктуру, Нужно точно понимать какие дополнительные ресурсы нам потребуются, а для этого надо провести расчеты уже после наших более приоритетных улучшений


### Целевая архитектура через пол года

За пол года скорее всего не реализовать все инициативы, поэтому стоит сконцентрироваться на самом необходимом и быстро реализуемом. В первую очередь это:
- Система мониторинга и алертов. Поможет в точности отслеживать производительность и сразу локализовать просадки. Логирование поможет быстрее отлаживать проблемы
- Кэширование данных. Даст максимально быстрый результат, проще всего реализовать
- Система трейсинга. Позволит упростить отлаживание сложной системы.
- Поменять процесс с MES API -> CRM на CRM -> MES API
- Горизонтальное масштабирование MES API. Вероятно поможет значительно повысить скорость и надежность системы

### Три самых необходимых изменения
- Добавить систему мониторинга и алертов. Поможет отслеживать текущие показатели и запланировать наиболее необходимые изменения во всей системе.
- Кеширование данных. Даст максимально быстрый результат, проще всего реализовать.
- Добавить систему трейсинга. Позволит упростить отлаживание сложной системы.
