## Мотивация

- Мониторинг позволит собирать метрики для бизнеса, такие как доля потерявшихся заказов, скорость разрешения проблем и так далее. На основе этих метрик можно будет принимать бизнес-решения
- Сократит время на диагностику и устранение проблем. Например, можно отслеживать по изменению метрик когда произошел инциндент, где произошел и тд, чтобы локализовывать проблемы
- Мониторинг позволит реагировать на критические ситуации заранее (например, в облаках есть автомасштабирование)
- Оптимизировать инфраструктуру по реальной нагрузке. Например, где то убавить ресурсы, а где то добавить
- Все эти меры помогают в конечном счете повысить надежность продукта, то есть уменьшить финансовые потери и повысить удовлетворенность пользователей за счет снижения доли потерянных заказов, ускорения их обработки
- С помощью метрик можно легко понять, все ли ок с сервисом в данный момент

## Выбор подхода к мониторингу

### API-сервисы (Shop, CRM, MES) 

**4 золотых сигнала (Latency, Traffic, Errors, Saturation)**

Этот метод выбран, так как пользовательский опыт критически зависит от быстродействия, задержек, отсутствия ошибок
- Latency - измеряем время ответа на запросы API
- Traffic - измеряем RPS, что поможет с анализом нагрузки
- Errors - отслеживаем 500 и другие проблемные коды
- Saturation - отслеживаем использование CPU/памяти сервисом

### Очереди сообщений (RabbitMQ)

**RED**

Важно контролировать скорость обработки сообщений, их количество и ошибки.
- Request Rate (частота запросов) – измерить сколько приходит запросов.
- Errors (ошибки сообщений) – фиксирует количество сообщений, попавших в Dead Letter Queue.
- Duration (время обработки сообщений) – помогает выявить задержки при передаче сообщений.

### Базы данных (Shop DB, MES DB)

**RED & USE**

- Requests Rate - частота запросов к БД
- Errors - ошибки запросов
- Duration - длительность выполнения запросов
- Utilization - загруженность RAM/CPU/Disk IO
- Saturation - количество подключений / задержка репликаций

### S3 
- Базовый размер

## Метрики и их обоснование

**RabbitMQ**

- Number of dead-letter-exchange letters in RabbitMQ (queue_name, reason) – определяет проблемы с некорректной обработкой заказов в разерезе причин отбраковки сообщений
- Number of message in flight in RabbitMQ (queue_name) – указывает на задержки в обработке очередей (например если консьюмер обрабатывает медленнее продьюсера), в разрезе очередей
- Queue depth (queue_name) - глубина очереди в разрезе очередей, смотрим на необработанные сообщения
- Количество подключений к брокеру (consumer_id, producer_id), чтобы посмотреть не отваливаются ли сервисы

**Shop API**

Если будет несколько инстансов, то ярлык - инстанс для метрик:
- Number of requests (RPS) for internet shop API - определим нагрузку на сервис по запросам
- Number of requests (RPS) per user for internet shop API - можно отсекать потенциальный DDOS и выявлять аномалии (вдруг одним аккаунтом много кто пользуется)
- CPU % for shop API - на сколько сервис загружен по железу и не надо ли увеличить мощности
- Memory Utilisation for shop API - на сколько сервис загружен по железу и не надо ли увеличить мощности
- Response time (latency) for shop API (как быстро мы отвечаем - важно для комфорта пользователя)
- Number of HTTP 200 for shop API (количество успешных запросов - важно для комфорта пользователей )
- Number of HTTP 500 for shop API (количество ошибок - важно для комфорта пользователей)
- Number of simultanious sessions for shop API (для мониторинга сколько юзеров одновременно сидят)
- Kb tranferred (received) for shop API (для мониторинга загружаемых пользователями файлов моделей)
- Kb provided (sent) for shop API - для мониторинга какие файлы по объему получаются в конструкторе

**MES API**

Если будет несколько инстансов, то ярлык - инстанс для метрик:
- Number of requests (RPS) for MES API - нагрузка на сервис, определим параметры роста нагрузки
- Number of requests (RPS) per user for MES API - для поиска аномалий
- CPU % for MES API - базовая утилизация, на сколько сервер загружен расчетами
- Memory Utilisation for MES API - базовая утилизация, на сколько сервер загружен расчетами
- Response time (latency) for MES API - как быстро отвечаем по расчетам, важно
- Number of HTTP 200 for MES API - количество успешных расчетов
- Number of HTTP 500 for MES API - количество ошибок расчетов
- Kb tranferred (received) for MES API - какие модели мы обсчитываем

**CRM API**

Если будет несколько инстансов, то ярлык - инстанс для метрик:
- Number of requests (RPS) for CRM API - нагрузка на сервис, определим параметры роста нагрузки
- Number of requests (RPS) per user for CRM API - для поиска аномалий
- CPU % for CRM API - базовая утилизация, на сколько сервер загружен
- Memory Utilisation for CRM API  - базовая утилизация, на сколько сервер загружен
- Response time (latency) for CRM API- как быстро отвечаем, важно для комфорта пользователя
- Number of HTTP 200 for CRM API - количество успешных запросов, важно для пользователя
- Number of HTTP 500 for CRM API - количество ошибок, важно для пользователя
- Number of simultanious sessions for CRM API - сколько сидит пользователей (сатурация сервиса)

**Базы данных**

- Memory Utilisation for shop db instance - базовый параметр для замера нагрузки
- Memory Utilisation for MES db instance - базовый параметр для замера нагрузки
- Number of connections for shop db instance (user_role) - как сильно используется пользователями по ролям
- Number of connections for MES db instance (user_role) - как сильно используется пользователями по ролям
- Size of S3 storage - чтобы расширять место по необходимости
- Size of shop db instance - чтобы расширять место по необходимости
- Size of MES db instance - чтобы расширять место по необходимости
- Query duration for shop db (query_type) - как быстро база отвечает
- Query duration for MES db (query_type) - как быстро база отвечает
- S3 Latency (bucket_name, operation) - время выполнения операций на запись / чтение, измеряем проивзодительность
- S3 number of requests (bucket_name, operation) - количество запросов, поможет выявить аномальную активность
- S3 File size (bucket_name, user) - поймем сколько в среднем занимает модель у юзеров, выявим аномалии


## План действий

1. Настройка системы мониторинга
- Развернуть Prometheus + Grafana для сбора и визуализации метрик.
- Настроить алерты на критические метрики.

2. Интеграция мониторинга в RabbitMQ
- Настроить мониторинг количества сообщений в очередях.
- Включить трекинг сообщений в мертвой очереди.
- Завести сбор выделенных метрик

3. Мониторинг API-сервисов
- Настроить логирование ошибок.
- Завести сбор выделенных метрик.

4. Мониторинг баз данных
- Добавить контроль за подключениями и нагрузкой на базы.
- Настроить алерты при превышении лимитов памяти.
- Завести сбор выделенных метрик

5. Мониторинг хранилища S3
- Контролировать рост объёма хранимых файлов.
- Завести сбор выделенных метрик
