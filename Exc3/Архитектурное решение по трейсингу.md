## Анализ схемы и планирование

-------
### MES API → MES DB / SHOP API -> SHOP DB / CRM API -> SHOP DB

Возможные проблемы: блокировки транзакций в базе данных.

Данные для трейсинга:

- trace_id, db_query_duration_seconds, db_connections_active
- db_lock_wait_time_seconds, query_execution_time_seconds – анализ эффективности работы базы
- slow_queries_count – количество медленных запросов

Возможные проблемы: потеря расчетов цены после длительного расчета

Данные для трейсинга:
- trace_id, price_calculation_duration, db_query_duration_seconds

-------
### MES API → RabbitMQ → CRM API

Возможные проблемы: задержка обновления статуса заказов для операторов, перегруженность очередей сообщений,
потеря сообщений, задержки в обработке очередей, дублирование сообщений.

Данные для трейсинга:
- trace_id, queue_name, message_id
- queue_depth, consumer_utilization, message_processing_time_seconds
- operator_id – идентификация оператора, обрабатывающего заказ
- dead_letter_queue_size – количество сообщений, попавших в мертвую очередь

------

#### 3D Files Storage → MES API

Возможные проблемы: задержка в обработке 3D-моделей, проблемы с доступом к файлам.

Данные для трейсинга:
- trace_id, file_name, file_size_bytes - основные данные по файлам
- storage_read_time_seconds, storage_write_time_seconds - показатели работы S3

-------

## Мотивация
Трейсинг позволяет получить детальную информацию о прохождении заказов через систему, выявить узкие места, сократить время диагностики проблем и улучшить производительность сервисов. 
Поскольку компания столкнулась с задержками в доставке заказов из-за застреваний в системе, надо выяснить все проблемы и решить их

Внедрение распределенного трейсинга позволит:
- Выявлять узкие места в реальном времени – анализ маршрута заказа по системе поможет находить и устранять причины задержек.
- Улучшить производительность системы – сбор данных о времени обработки запросов, очередей сообщений и взаимодействия сервисов поможет оптимизировать нагрузку.
- Сократить количество просроченных заказов – контроль за обработкой заказов через все этапы позволит минимизировать случаи зависания на отдельных шагах.
- Повысить прозрачность работы API и интеграций – аналитика межсервисных взаимодействий позволит быстро выявлять проблемные интеграции.
- Автоматизировать выявление критических проблем – мониторинг с пороговыми значениями обеспечит раннее обнаружение аномалий.


Внедрение трейсинга окажет позитивное влияние на несколько ключевых метрик, критичных для бизнеса «Александрит»:
- Среднее время обработки заказа. Из-за потерей заказов срываются сроки выполнения, клиенты уходят. После настройки трейсинга и фикса багов, заказы должны перестать теряться, что положительно скажется на времени изготовления заказа
- Средняя задержка выполнения API запросов. Рост нагрузки замедляет всю систему и трейсинг позволит выявить части системы, которые не справляются с нагрузкой и масштабировать их. Это позволит повысить удовлетворенность клиента от работы с продуктом
- Количество сообщений в мертвой очереди. Можно будет своевременно исправлять ошибки маршрутизации сообщений и балансировать нагрузку.


## Предлагаемое решение
Для внедрения трейсинга в систему компании «Александрит» предлагается использовать OpenTelemetry в связке с Jaeger и ELK. 
Эти технологии позволят собирать, агрегировать и визуализировать трассировку запросов через всю систему.

Для успешной реализации трейсинга потребуется доработать следующие компоненты системы:

### Shop API, CRM API, MES API
- Добавить генерацию trace_id во входящие и исходящие HTTP-запросы, а также очереди сообщений
- Добавить интеграцию с OpenTelemetry SDK.

### RabbitMQ
- Внедрить trace_id в заголовки сообщений, передаваемых через очереди.
- Настроить мониторинг глубины очередей и времени обработки сообщений.

### MES DB, Shop DB
- Добавить логирование долгих запросов и трассировку операций записи/чтения.
- Включить трейсинг SQL-запросов с использованием query_execution_time_seconds.

### 3D Files Storage
- Добавить измерение времени обработки файлов (storage_read_time_seconds, storage_write_time_seconds).
- Включить трассировку загрузки и обработки файлов в OpenTelemetry.


### Файл с обновленной диаграммой находится в папке Exc3 (в этой же папке)

## Компромиссы
### Высокая стоимость хранения и обработки данных

- Трассировка всех запросов и сообщений требует значительного объема хранилища и ресурсов обработки.
- Решение: внедрение выборочного трейсинга, при котором логируются только медленные или ошибочные запросы.

### Ограничения проприетарных компонентов

- Некоторые сторонние системы и библиотеки, используемые в инфраструктуре, могут не поддерживать трейсинг из коробки или предлагать собирать только определенные метрики

### Дополнительная нагрузка на производительность
- Сбор трассировочных данных увеличивает задержки при обработке запросов и в целом нагружает сервера.
- Решение: балансировка между глубиной трейсинга и его полезностью, выборочное логирование на основе пороговых значений.

### Сложность интеграции с существующей кодовой базой
- Внедрение трейсинга требует модификации всех ключевых сервисов, что может занять значительное время.
- Легаси код может быть сложен для понимания и сложно внедрять трейсинг / логирование в таких условиях
- Решение: поэтапное внедрение, начиная с критических сервисов, например MES API

### Где трейсинг пока точно не принесёт пользы
- Операции с низкой задержкой (например, простые запросы к базе без сложных вычислений) – избыточный трейсинг таких операций приведет к ненужному потреблению ресурсов. Например для операций между CRM и CRM API 
- Разовые или редко выполняемые задачи (например, админские операции в CRM) – их трассировка не даст значимого улучшения

## Аспекты безопасности
- Аутентификация и авторизация - доступ к системам Jaeger, ELK смогут получить только авторизованные сотрудники с правами Support, Admin, DevOps
- Интеграция с SSO на базе корпоративной системы - так мы будем давать доступ только сотрудникам
- Шифрование данных - включить TLS для шифрования трафика 
- Закрыть доступ из интернета и оставить доступ из внутренней сети. Или ограничить доступ только по white IP list + корпоративный VPN
- Логирование и мониторинг подозрительной активности - логи доступов, алерты по подозрительным активностям
- Минимизация сбора чувствительных данных - исключить любые персональные данные, автоматизировать удаление старых трассировок, анонимизированные айдишники вместо номеров заказов / юзер ид и тд

