## Анализ

Основная причина медленно работы MES - это постоянные запросы к БД и обработка длинных списков заказов на странице оператора.
Имеет смысл закешировать:
- Список заказов для быстрого отражения на странице
- Результаты расчета цены, чтобы не пересчитывать / не забирать из базы цену каждый раз

Таким образом, при открытии страницы MES оператор сразу получает данные из кэша, а не ждёт полного запроса к базе. Это ускорит отклик интерфейса и снимет часть нагрузки, улучшая общее время работы с системой.

## Мотивация
У операторов долго грузится страница с заказами и увеличивается время отклика при работе с системой.
При этом, одни и те же данные постоянно запрашиваются у системы (например, проверка нет ли новых заказов), что требует полного выполнения запроса в бд и слишком перегружает систему.

### Что поможет решить внедрение кеширования
- Скорость работы страницы с заказами
- Снижение нагрузки на базу (снижаем повторные запросы)
- Ускорение работы интерфейса

### Что будем кешировать
- список доступных заказов для оператора
- список заказов в работе
- результаты расчета цены (чтобы каждый раз не ходить в бд при просмотре страницы с этой информацией)

### Предлагаемое решение
Мы будем использовать серверное кеширование по паттерну Write-Through.
В нашем случае важно, чтобы операторы имели актуальные данные, поэтому важно обновлять и бд и кеш одновременно.
- Cache-aside нам не подходит, потому что новые данные будут кешироваться только при запросе пользователя. Вместо этого лучше сразу кешировать актуальные данные, которые точно будут запрашиваться и не ждать запроса от оператора. Это поможет снизить нагрузку.
- Refresh-ahead нужно четко понимать, когда принудительно обновлять кеш. Это подходит для систем с прогнозируемым обновлением данных, однако в MES заказы появляются случайно, поэтому ничего предугадать невозможно.

Схема с sequence схемой находится в этой же папке в формате plantuml

### Инвалидация
Для решения проблемы актуальности, будем использовать программную инвалидацию. 
В нашем случае при изменении заказа (создали / оператор взял в работу и тд)
MES сервис обновляет кеш. 

Почему нам это подходит:
- гарантирована актуальность данных, все проходит через кеш и пользователь всегда видит акуальные данные
- не ждем, когда кеш обнулится по времени, поскольку важна актуальность данных по заказам


Рассмотрим все стратегии:

#### Временная инвалидация
(+) простота реализации (просто по времени)

(-) будет выдавать просроченные данные, если неверно настроить время инвалидации. Поскольку заказы меняются в случайное время - нормально настроить это время не получится


#### Основанная на запросах
(+) Просто привязывается к конкретным действиям пользователя. Например, менеджер нажал "отправить в производство" - сразу сбросили кеш

(-) Нужно прорабатывать сценарии обновления, можно что-то забыть или не учесть

#### На основе изменений
(+) Данные в кеше всегда актуальны (что критично для MES)

(-) Надо настраивать и реализовывать триггеры, при высокой частоте изменений будем постоянно инвалидировать кеш, что сведет на нет его работу

#### Программная инвалидация
(+) Можно заложить нужные бизнес правила. Например, обновили статус заказа - инвалидировали

(-) Сложнее реализовывать, надо провести бизнес аналитику того что и когда инвалидировать


#### Инвалидация по ключу
(+) Избирательное обновление, точечно корректируем при необходимости

(-) Нужна логика управления ключами, определить какие объекты к каким ключам относятся, где-то это хранить

